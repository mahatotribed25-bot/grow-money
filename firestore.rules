
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions to make rules more readable and reusable.
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    function isAdmin() {
      // In a production app, this should be based on custom claims,
      // but for now, we will identify the admin by a specific email address.
      return request.auth.token.email == "admin@tribed.world";
    }

    // Rules for the 'users' collection.
    match /users/{userId} {
      // A user can create their own document, or an admin can.
      allow create: if isOwner(userId);
      // A user can read or update their own data. Admin has full read/update access.
      allow read, update: if isOwner(userId) || isAdmin();
      // Only an admin can delete a user account.
      allow delete: if isAdmin();
    }

    // Rules for 'investmentPlans' collection.
    match /investmentPlans/{planId} {
      // Any signed-in user can view the available plans.
      allow read: if isSignedIn();
      // Only an admin can create, update, or delete investment plans.
      allow write: if isAdmin();
    }
    
    // Rules for a user's 'investments' sub-collection.
    match /users/{userId}/investments/{investmentId} {
      // A user can only read their own investments. Admin can read any.
      allow read: if isOwner(userId) || isAdmin();
      // Creating, updating, or deleting investments is handled by secure server-side logic (transactions)
      // initiated by the user or admin, so direct client writes are restricted to admins for management.
      allow write: if isAdmin(); 
    }
    
    // Rules for 'deposits' collection.
    match /deposits/{depositId} {
      // A user can only create a deposit request for themselves.
      allow create: if isOwner(request.resource.data.userId);
      // A user can read their own deposit history. Admin can read all.
      allow read: if isOwner(resource.data.userId) || isAdmin();
      // Only an admin can approve or reject a deposit request.
      allow update: if isAdmin();
    }
    
    // Rules for 'withdrawals' collection.
    match /withdrawals/{withdrawalId} {
      // A user can only create a withdrawal request for themselves.
      allow create: if isOwner(request.resource.data.userId);
      // A user can read their own withdrawal history. Admin can read all.
      allow read: if isOwner(resource.data.userId) || isAdmin();
      // Only an admin can approve or reject a withdrawal request.
      allow update: if isAdmin();
    }

    // Rules for admin-specific settings.
    match /settings/admin {
      // Any signed-in user can read settings (e.g., to get the admin UPI ID).
      allow read: if isSignedIn();
      // Only an admin can change the settings.
      allow write: if isAdmin();
    }
    
    // Rules for announcements.
    match /announcements/{announcementId} {
      // All signed-in users can read announcements.
      allow read: if isSignedIn();
      // Only an admin can create or delete announcements.
      allow write: if isAdmin();
    }

    // Rules for 'loanPlans' collection.
    match /loanPlans/{planId} {
      // Any signed-in user can view available loan plans.
      allow read: if isSignedIn();
      // Only an admin can create, update, or delete loan plans.
      allow write: if isAdmin();
    }

    // Rules for 'loanRequests' collection.
    match /loanRequests/{requestId} {
       // A user can only create a loan request for themselves.
      allow create: if isOwner(request.resource.data.userId);
      // A user can read their own request. Admin can read all.
      allow read: if isOwner(resource.data.userId) || isAdmin();
      // Only an admin can approve or reject loan requests.
      allow update: if isAdmin();
    }

    // Rules for a user's active 'loans' sub-collection.
    match /users/{userId}/loans/{loanId} {
      // A user can only read their own active loans. Admin can read any.
      allow read: if isOwner(userId) || isAdmin();
      // Active loans are managed via admin actions, so only admin can write.
      allow write: if isAdmin(); 
    }

    // Rules for Group Loan Investment System
    match /groupLoanPlans/{planId} {
      // Any signed-in user can view group loan plans.
      allow read: if isSignedIn();
      // Only an admin can create or update the plans.
      allow write: if isAdmin(); 
    }

    match /groupLoanPlans/{planId}/investments/{investmentId} {
      // Any signed-in user can see who has invested in a plan.
      allow read: if isSignedIn();
      // A user can only create an investment for themselves.
      allow create: if isOwner(request.resource.data.investorId); 
      // Only an admin can update (e.g., for distributing payouts) or delete records.
      allow update, delete: if isAdmin();
    }
    
    match /groupLoanPlans/{planId}/repayments/{repaymentId} {
      // Only an admin can manage borrower repayment records.
      allow read, write: if isAdmin(); 
    }

    match /groupLoanPlans/{planId}/payouts/{payoutId} {
      // Only an admin can manage the investor payout records.
      allow read, write: if isAdmin();
    }
    
    // Fallback rule: Deny all other reads/writes by default.
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
