
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Settings can be read by any user, authenticated or not.
    // Writing is restricted to admin.
    match /settings/admin {
      allow read: if true;
      allow write: if request.auth != null && request.auth.token.email == "admin@tribed.world";
    }

    // Helper functions to make rules more readable and reusable.
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }
    
    function isAdmin() {
      return request.auth != null && request.auth.token.email == "admin@tribed.world";
    }

    // Rules for the 'users' collection.
    match /users/{userId} {
      // A user can create their own document.
      allow create: if isOwner(userId);
      // A user can read their own data. Admin can read all.
      allow read: if isOwner(userId) || isAdmin();
      // A user can update their own data. Admin has full update access.
      allow update: if isOwner(userId) || isAdmin();
      // Only an admin can delete a user account.
      allow delete: if isAdmin();
    }

    // Rules for 'investmentPlans' collection.
    match /investmentPlans/{planId} {
      // Any signed-in user can view the available plans.
      allow read: if request.auth != null;
      // Only an admin can create, update, or delete investment plans.
      allow write: if isAdmin();
    }
    
    // Rules for a user's 'investments' sub-collection.
    match /users/{userId}/investments/{investmentId} {
      // A user can only read their own investments. Admin can read any.
      allow read, write: if isOwner(userId) || isAdmin();
    }
    
    // Rules for 'deposits' collection.
    match /deposits/{depositId} {
      // A user can only create a deposit request for themselves.
      allow create: if request.auth != null && isOwner(request.resource.data.userId);
      // A user can read their own deposit history. Admin can read all.
      allow read: if (request.auth != null && isOwner(resource.data.userId)) || isAdmin();
      // Only an admin can approve or reject a deposit request.
      allow update: if isAdmin();
    }
    
    // Rules for 'withdrawals' collection.
    match /withdrawals/{withdrawalId} {
      // A user can only create a withdrawal request for themselves.
      allow create: if request.auth != null && isOwner(request.resource.data.userId);
      // A user can read their own withdrawal history. Admin can read all.
      allow read: if (request.auth != null && isOwner(resource.data.userId)) || isAdmin();
      // Only an admin can approve or reject a withdrawal request.
      allow update: if isAdmin();
    }
    
    // Rules for announcements.
    match /announcements/{announcementId} {
      // All signed-in users can read announcements.
      allow read: if request.auth != null;
      // Only an admin can create or delete announcements.
      allow write: if isAdmin();
    }

    // Rules for 'loanPlans' collection.
    match /loanPlans/{planId} {
      // Any signed-in user can view available loan plans.
      allow read: if request.auth != null;
      // Only an admin can create, update, or delete loan plans.
      allow write: if isAdmin();
    }

    // Rules for 'loanRequests' collection.
    match /loanRequests/{requestId} {
       // A user can only create a loan request for themselves.
      allow create: if request.auth != null && isOwner(request.resource.data.userId);
      // A user can read their own request. Admin can read all.
      allow read: if (request.auth != null && isOwner(resource.data.userId)) || isAdmin();
      // Only an admin can approve or reject loan requests.
      allow update: if isAdmin();
    }

    // Rules for UPI Verification Requests
    match /upiRequests/{requestId} {
      // A user can create a request for themselves.
      allow create: if request.auth != null && isOwner(request.resource.data.userId);
      // A user can read their own request. Admin can read all.
      allow read: if (request.auth != null && isOwner(resource.data.userId)) || isAdmin();
      // Only an admin can update (approve/reject) requests.
      allow update: if isAdmin();
    }

    // Rules for a user's active 'loans' sub-collection.
    match /users/{userId}/loans/{loanId} {
      // A user can read their own loan data.
      allow read: if isOwner(userId) || isAdmin();
      // Admin can create or delete loan records.
      allow create, delete: if isAdmin();
      // User can update status (e.g. to 'Payment Pending') or an admin can manage the record.
      // The system (running on client) can also update to 'Due'.
      allow update: if isOwner(userId) || isAdmin();
    }

    // Rules for Group Loan Investment System
    match /groupLoanPlans/{planId} {
      // Any signed-in user can view group loan plans.
      allow read: if request.auth != null;
      // Only an admin can create or update the plans.
      allow write: if isAdmin(); 
    }

    match /groupLoanPlans/{planId}/investments/{investmentId} {
      // Any signed-in user can see who has invested in a plan.
      allow read: if request.auth != null;
      // A user can only create an investment for themselves.
      allow create: if request.auth != null && isOwner(request.resource.data.investorId); 
      // Only an admin can update (e.g., for distributing payouts) or delete records.
      allow update, delete: if isAdmin();
    }
    
    match /groupLoanPlans/{planId}/repayments/{repaymentId} {
      // Only an admin can manage borrower repayment records.
      allow read, write: if isAdmin(); 
    }

    match /groupLoanPlans/{planId}/payouts/{payoutId} {
      // Only an admin can manage the investor payout records.
      allow read, write: if isAdmin();
    }

    // KYC Requests (Collection Group Query)
    match /kycRequests/{requestId} {
      allow read, write: if isAdmin();
    }

     // Investments (Collection Group Query for Admin Dashboard)
    match /{path=**}/investments/{investmentId} {
      allow read: if isAdmin();
    }
    
    // Fallback rule: Deny all other reads/writes by default.
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
